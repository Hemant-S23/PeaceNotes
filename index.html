<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeaceNotes - The Premium Experience</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* --- CSS Global Variables (Default: Light Mode) --- */
        :root { /* Default is Light Mode */
            --bg-color: #f0f2f5; 
            --primary-surface: #ffffff; 
            --secondary-surface: #e0e6ed; 
            --primary-text: #1f1f1f; 
            --secondary-text: #666666; 
            --shadow-color: rgba(0, 0, 0, 0.15); 
            
            --theme-primary: #007bff; 
            --theme-secondary: #0056b3; 
            --theme-accent-glow: rgba(0, 123, 255, 0.2); 

            --glass-bg-base: var(--primary-surface); 
            --glass-border-base: var(--secondary-surface);
        }

        /* --- Dark Mode Variables (from sample.html concept) --- */
        body[data-theme="dark"] { /* Use data-theme attribute */
            --bg-color: #1a1a2e; 
            --primary-surface: #2c2c54; 
            --secondary-surface: #40407a; 
            --primary-text: #f0f6fc; 
            --secondary-text: #b0b0d0; 
            --shadow-color: rgba(0, 0, 0, 0.5); 
            
            --theme-primary: #3b82f6; 
            --theme-secondary: #2563eb; 
            --theme-accent-glow: rgba(59, 130, 246, 0.3); 

            --glass-bg-base: rgba(0, 0, 0, 0.2); 
            --glass-border-base: rgba(255, 255, 255, 0.1);
        }

        /* --- Base & Universal Styles --- */
        * { 
            box-sizing: border-box; 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease, filter 0.3s ease, opacity 0.3s ease;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            height: 100vh;
            overflow: hidden; 
        }

        /* --- Screen Management --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .screen.active { opacity: 1; visibility: visible; }

        /* --- Containers & Inputs --- */
        .container {
            background: var(--primary-surface); padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow-color); text-align: center;
            width: 90%; max-width: 400px; border: 1px solid var(--secondary-surface);
        }
        h1 { font-weight: 700; margin-bottom: 10px; color: var(--primary-text); } 
        .container p { color: var(--secondary-text); margin-bottom: 30px; }
        .styled-input {
            width: 100%; padding: 15px; border: 1px solid var(--secondary-surface);
            border-radius: 12px; background-color: var(--secondary-surface);
            color: var(--primary-text); font-size: 16px; text-align: center; 
        }
        .styled-input:focus { outline: none; box-shadow: 0 0 0 3px var(--theme-accent-glow); }

        /* --- Buttons --- */
        .btn {
            width: 100%; padding: 15px; border: none; background: linear-gradient(45deg, var(--theme-secondary), var(--theme-primary));
            color: white; font-size: 16px; font-weight: 600; border-radius: 12px; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            margin-top: 10px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 25px var(--theme-accent-glow); }
        .btn-secondary { 
            background: var(--secondary-surface); 
            color: var(--primary-text); 
            box-shadow: none; 
        }
        .btn-secondary:hover { 
            background: var(--secondary-surface); 
            transform: translateY(-2px); 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }


        .chat-container { 
            width: 100%; 
            height: 100%; 
            background-color: var(--bg-color); 
            display: flex; 
            flex-direction: column; 
        }
        .chat-header {
            padding: 15px 20px; 
            background: var(--primary-surface); 
            backdrop-filter: blur(10px); 
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; border-bottom: 1px solid var(--secondary-surface);
        }

        .chat-header h3 { margin: 0; font-weight: 600; }
        .chat-header span { color: var(--theme-primary); font-weight: 700; }
        
        .btn-leave { 
            background: #e74c3c; 
            color: white; 
            font-size: 20px; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center;
            justify-content: center;
            margin: 0; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer; 
        }
        .btn-leave:hover {
            background: #c0392b; 
            transform: scale(1.05); 
            box-shadow: 0 4px 15px var(--shadow-color); 
        }


        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px; 
        }
        .header-controls .btn-control { 
            background: none; border: none; color: var(--primary-text); 
            font-size: 20px; cursor: pointer; padding: 5px; border-radius: 50%;
        }
        .header-controls .btn-control:hover { transform: scale(1.1); color: var(--theme-primary); }

        #player-toggle-view-button { 
            display: flex; align-items: center;
            background: linear-gradient(45deg, var(--theme-secondary), var(--theme-primary));
            padding: 8px 15px; border-radius: 20px; 
            font-size: 0.9em; font-weight: 600; color: white;
            box-shadow: 0 2px 10px var(--shadow-color);
            width: auto; margin: 0; 
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
        }
        #player-toggle-view-button i { margin-left: 8px; font-size: 1.1em; }
        #player-toggle-view-button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--theme-accent-glow); }

        .chat-body { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* E2E Notice */
        #e2e-notice {
            background-color: var(--secondary-surface); 
            color: var(--primary-text);
            font-size: 0.85em; 
            text-align: center;
            padding: 15px;
            width: 80%; 
            margin: 20px auto; 
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center; 
            gap: 10px;
            opacity: 1;
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: translateY(0);
        }
        #e2e-notice.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            display: none; 
        }
        #e2e-notice i {
            color: var(--theme-primary); 
            font-size: 1em; 
            margin-right: 8px; 
        }


        /* --- THE PREMIUM FLOATING PLAYER POPUP --- */
        #music-player-popup {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0.8); 
            transform-origin: center center; 
            
            background: var(--glass-bg-base); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border-base); 
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--shadow-color); 
            width: 90%; 
            max-width: 400px; 
            padding: 25px; 
            text-align: center;
            z-index: 200; 
            
            opacity: 0; 
            pointer-events: none; 
            display: none; 

            transition: opacity 0.3s ease-out, transform 0.3s ease-out; 
        }
        /* Disable blur effect in light mode */
        body:not([data-theme="dark"]) #music-player-popup { 
            backdrop-filter: none; -webkit-backdrop-filter: none;
        }

        #music-player-popup.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1); 
            pointer-events: all; 
        }

        #audio-player-ui { 
            background: none; border: none; margin: 0; border-radius: 0; padding: 0; display: block; 
        }
        .player-content { display: flex; flex-direction: column; align-items: center; }
        
        /* Album Art Container with default icon */
        #album-art-container {
            width: 150px; height: 150px; border-radius: 12px; overflow: hidden; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 25px var(--shadow-color); margin-bottom: 20px;
            background-color: var(--secondary-surface); 
            color: var(--primary-text); 
        }
        #album-art-container img {
            width: 100%; height: 100%; object-fit: cover; 
            display: none; 
        }
        #album-art-container .fas.fa-headphones { 
            font-size: 80px; 
            color: var(--secondary-text); 
        }

        #song-title { font-size: 22px; font-weight: 700; margin: 0; color: var(--primary-text); } 
        body[data-theme="dark"] #song-title { text-shadow: 0 1px 3px rgba(0,0,0,0.3); } 
        body:not([data-theme="dark"]) #song-title { text-shadow: none; } 
        #song-artist { font-size: 16px; color: var(--secondary-text); margin: 5px 0 20px 0; }
        
        .progress-container { width: 100%; margin-bottom: 10px; }
        #progress-bar {
            -webkit-appearance: none; width: 100%; height: 6px; background: var(--glass-border-base); 
            border-radius: 5px; outline: none; cursor: pointer;
        }
        #progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            background: var(--theme-secondary); border-radius: 50%;
        }

        .time-display {
            display: flex; justify-content: space-between; width: 100%; color: var(--secondary-text);
            font-size: 0.85em; margin-top: 5px;
        }

        .player-controls { 
            display: flex; align-items: center; justify-content: center; width: 100%; 
            margin-bottom: 15px; 
        }
        .player-controls .btn-control {
            background: none; border: none; color: var(--primary-text); 
            font-size: 22px; margin: 0 25px; cursor: pointer; 
        }
        .player-controls .btn-control:hover { transform: scale(1.1); color: var(--theme-primary); } 
        .player-controls .btn-main { font-size: 44px; }
        
        #music-search-button {
            margin: 20px auto 0 auto; 
            display: block;
            max-width: 250px; 
        }

        .messages-area { 
            flex-grow: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }
        .message { padding: 12px 18px; border-radius: 20px; margin-bottom: 10px; max-width: 75%; word-wrap: break-word; line-height: 1.5; }
        .message .sender-name { font-weight: 700; font-size: 0.9em; margin-bottom: 4px; display: block; color: var(--theme-primary); }
        .message.sent { background: linear-gradient(45deg, var(--theme-secondary), var(--theme-primary)); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .message.sent .sender-name { color: rgba(255,255,255,0.8); }
        .message.received { background-color: var(--secondary-surface); align-self: flex-start; border-bottom-left-radius: 5px; }
        .message.system { background: none; color: var(--secondary-text); font-style: italic; font-size: 0.9em; align-self: center; text-align: center; }
        
        /* Message Input Form Layout */
        .message-input-form {
            display: flex;
            padding: 20px;
            background: var(--primary-surface);
            flex-shrink: 0;
            gap: 10px; 
            align-items: center; 
        }
        .message-input-form .styled-input {
            margin: 0; 
            flex-grow: 1; 
            text-align: left; 
        }
        #emoji-button {
            width: 40px; height: 40px; 
            padding: 0; border: none; background: none;
            color: var(--secondary-text); 
            font-size: 20px; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #emoji-button:hover {
            color: var(--theme-primary);
            transform: scale(1.1);
        }

        .message-input-form .send-btn { 
            width: 40px; 
            height: 40px; 
            padding: 0; 
            margin-top: 0; 
            border-radius: 50%; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            display: flex; 
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, var(--theme-secondary), var(--theme-primary)); 
            color: white; 
        }
        .message-input-form .send-btn i {
            margin: 0; 
            font-size: 1.1em; 
        }
        .message-input-form .send-btn:hover {
            transform: translateY(-1px); 
            box-shadow: 0 3px 12px var(--theme-accent-glow);
        }
        
        /* Modals (General styling applies to all modals) */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); 
            display: none; justify-content: center; align-items: center; 
            z-index: 300; 
        } 
        .modal-content { 
            background: var(--primary-surface); padding: 25px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 80vh; 
            display: flex; flex-direction: column; border: 1px solid var(--secondary-surface);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--secondary-surface); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--primary-text); } 
        .modal-close { font-size: 28px; cursor: pointer; color: var(--secondary-text); }

        /* Search Modal Specifics */
        .search-result-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; }
        .search-result-item:hover { background-color: var(--secondary-surface); }
        .search-result-item img { width: 60px; height: 60px; border-radius: 8px; margin-right: 15px; object-fit: cover; } 
        .search-result-info h4 { margin: 0 0 5px 0; font-size: 1em; color: var(--primary-text); } 
        .search-result-info p { margin: 0; font-size: 0.9em; color: var(--secondary-text); }

        /* Delete Confirmation Modal Specifics */
        #delete-room-modal .modal-body { text-align: center; }
        #delete-room-modal .modal-body p { margin-bottom: 20px; }
        #delete-room-modal .modal-body .btn { margin-bottom: 10px; }

        /* Custom Alert Modal Styling */
        #custom-alert-modal .modal-content { text-align: center; }
        #custom-alert-modal .modal-header { justify-content: center; border-bottom: none; padding-bottom: 0; margin-bottom: 15px; }
        #custom-alert-modal .modal-header h2 { font-size: 1.5em; }
        #custom-alert-modal .modal-body { margin-top: 10px; }
        /* Button wrapper for custom alert single button */
        .modal-button-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 20px; /* Space above buttons */
            gap: 10px; /* Space between multiple buttons */
        }
        .modal-button-wrapper .btn {
            width: auto; /* Override 100% width */
            padding: 10px 30px;
            margin: 0; /* Remove default margin-top */
        }

        /* Share Room Modal Styling */
        #share-room-modal .modal-body { text-align: center; }
        #share-room-modal .room-info-display {
            background-color: var(--secondary-surface);
            padding: 15px; border-radius: 12px; margin-bottom: 20px; word-break: break-all;
            color: var(--primary-text); 
        }
        #share-room-modal .room-info-display p { margin: 5px 0; font-size: 0.9em; color: var(--secondary-text); }
        #share-room-modal .room-info-display strong { color: var(--primary-text); font-size: 1.2em; }
        #share-room-modal .action-buttons { display: flex; gap: 10px; margin-top: 10px; }
        #share-room-modal .action-buttons .btn { flex-grow: 1; width: auto; padding: 10px 15px; font-size: 0.9em; }
        #copy-pin-button { background: var(--secondary-surface); color: var(--primary-text); }
        #copy-pin-button:hover { background: #3a3a3a; transform: translateY(-2px); }

        /* Room PIN Display (Hidden by default, shown by eye button) */
        .room-pin-wrapper {
            display: flex;
            align-items: center;
            gap: 10px; 
        }
        .room-pin-wrapper #room-pin-display {
            font-weight: 700;
            color: var(--theme-primary);
            transition: filter 0.3s ease;
        }
        .room-pin-wrapper #room-pin-display.hidden-pin {
            filter: blur(5px); 
        }
        .room-pin-wrapper #toggle-pin-visibility-button {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
        }
        .room-pin-wrapper #toggle-pin-visibility-button:hover {
            color: var(--theme-primary);
        }

        /* Member Count Display */
        .member-count-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--secondary-text); 
            cursor: pointer; 
            transition: color 0.2s ease;
        }
        .member-count-wrapper:hover {
            color: var(--theme-primary); 
        }
        .member-count-wrapper i {
            font-size: 1.1em;
            color: var(--theme-primary); 
        }

        /* Member List Modal */
        #member-list-modal .modal-content {
            max-height: 60vh;
        }
        #member-list-modal ul {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto; 
            flex-grow: 1;
        }
        #member-list-modal li {
            padding: 10px 0;
            border-bottom: 1px solid var(--secondary-surface);
            display: flex;
            align-items: center;
            color: var(--primary-text);
            font-size: 1.1em;
        }
        #member-list-modal li:last-child {
            border-bottom: none;
        }
        #member-list-modal li i { 
            margin-right: 10px;
            color: var(--theme-primary);
        }
        /* Kick button in member list */
        .member-list-modal .kick-btn {
            background: none;
            border: none;
            color: #e74c3c; 
            font-size: 1.2em;
            margin-left: auto; 
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 5px;
        }
        .member-list-modal .kick-btn:hover {
            transform: scale(1.1);
        }

        /* Emoji Modal */
        #emoji-modal .modal-content {
            max-width: 350px;
            max-height: 350px;
            padding: 15px;
        }
        #emoji-modal .modal-header {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 10px;
        }
        #emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 5px; 
        }
        .emoji-item {
            font-size: 28px;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 8px;
        }
        .emoji-item:hover {
            background-color: var(--secondary-surface);
        }

    </style>
</head>
<body>
    <div id="youtube-player-hidden" style="position: absolute; top: -9999px; left: -9999px;"></div>

    <div id="name-screen" class="screen active"> <div class="container"> <h1>PeaceNotes</h1> <p>The Premium Listening Experience</p> <input type="text" id="name-input" class="styled-input" placeholder="Your Name" autocomplete="off"> <button id="continue-button" class="btn">Enter</button> </div> </div>
    <div id="home-screen" class="screen"> <div class="container"> <h1 id="welcome-message"></h1> <p>Create a room or enter a PIN to listen with friends.</p> <button id="create-room-button" class="btn">Create New Room</button> <p style="margin: 20px 0;">OR</p> <input type="text" id="pin-input" class="styled-input" placeholder="Enter Room PIN"> <button id="join-button" class="btn btn-secondary">Join Room</button> </div> </div>
    <div id="chat-screen" class="screen"> 
        <div class="chat-container"> 
            <div class="chat-header"> 
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="room-pin-wrapper">
                        <h3>PIN:</h3> 
                        <span id="room-pin-display" class="hidden-pin"></span>
                        <button id="toggle-pin-visibility-button" class="btn-control" title="Toggle PIN Visibility"><i class="fas fa-eye"></i></button>
                    </div>
                    <div id="member-count-wrapper" class="member-count-wrapper" title="View Members">
                        <i class="fas fa-users"></i>
                        <span id="member-count-display">0</span>
                    </div>
                </div>

                <div class="header-controls">
                    <button id="theme-toggle-button" class="btn-control" title="Toggle Theme"><i data-lucide="moon" class="icon"></i></button>
                    <button id="player-toggle-view-button" class="btn" title="Toggle Player View">Vibana <i class="fas fa-plus"></i></button>
                    <button id="leave-room-button" class="btn-control btn-leave" title="Leave Room"><i class="fas fa-right-from-bracket"></i></button>
                </div>
            </div> 
            <div class="chat-body"> 
                <div id="e2e-notice">
                    <i class="fas fa-lock"></i> 
                    Messages are end-to-end encrypted. No one outside of this chat, not even PeaceNotes, can read them.
                </div>
                <div class="messages-area" id="messages-area"></div> 
            </div> 
            <form class="message-input-form" id="message-form"> 
                <button type="button" id="emoji-button"><i class="far fa-smile"></i></button> 
                <input type="text" id="message-input" class="styled-input" placeholder="Type a message..." autocomplete="off"> 
                <button type="submit" class="send-btn"><i class="fas fa-paper-plane"></i></button> 
            </form> 
        </div> 
    </div>
    
    <!-- Music Player Pop-up (Fixed position, NOT inside chat-body) -->
    <div id="music-player-popup"> 
        <div id="audio-player-ui"> 
            <div class="player-content"> 
                <div id="album-art-container">
                    <img id="album-art" src="" alt="Album Art"> 
                    <i class="fas fa-headphones"></i> 
                </div>
                <h4 id="song-title">No music selected</h4> 
                <p id="song-artist">Use the search button to find music</p> 
                <div class="progress-container"> 
                    <input type="range" id="progress-bar" value="0" step="1"> 
                    <div class="time-display">
                        <span id="current-time">00:00</span>
                        <span id="total-duration">00:00</span>
                    </div>
                </div> 
                <div class="player-controls"> 
                    <button id="rewind-button" class="btn-control"><i class="fas fa-backward-step"></i></button> 
                    <button id="play-pause-button" class="btn-control btn-main"><i class="fas fa-play-circle"></i></button> 
                    <button id="forward-button" class="btn-control"><i class="fas fa-forward-step"></i></button> 
                </div> 
                <div class="aux-player-controls">
                    <button id="mute-button" class="btn-control" title="Mute/Unmute"><i class="fas fa-volume-up"></i></button>
                    <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="100">
                    <button id="repeat-button" class="btn-control" title="Toggle Repeat"><i class="fas fa-redo"></i></button>
                </div>
            </div> 
        </div> 
        <button id="music-search-button" class="btn">Search Music</button> 
    </div> 

    <div id="search-modal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>Search YouTube</h2> <span class="modal-close" id="modal-close-button">×</span> </div> <div class="modal-body"> <form id="modal-search-form" style="display: flex; margin-bottom: 15px;"> <input type="text" id="modal-search-input" class="styled-input" style="margin: 0;" placeholder="Enter song or artist..."> <button type="submit" class="btn" style="width: 100px; margin-left: 10px; margin-top: 0;">Search</button> </form> <ul id="search-results"></ul> </div> </div> </div>

    <div id="delete-room-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Room Deletion</h2>
                <span class="modal-close" id="delete-modal-close-button">×</span>
            </div>
            <div class="modal-body">
                <p>You are the **last member** in this room.</p>
                <p>If you leave, the room and **all its data (messages, music, members)** will be **permanently deleted** and cannot be recovered.</p>
                <p>Are you sure you want to delete this room permanently?</p>
                <button id="confirm-delete-button" class="btn" style="background: #e74c3c;">Yes, Delete Room Permanently</button>
                <button id="cancel-delete-button" class="btn btn-secondary">No, Stay in Room</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="custom-alert-title">Notification</h2>
            </div>
            <div class="modal-body">
                <p id="custom-alert-message">This is a custom alert message.</p>
                <div class="modal-button-wrapper"> <!-- NEW: Button wrapper for custom alert buttons -->
                    <button id="custom-alert-close-button" class="btn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="share-room-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Room Created! Share Now.</h2>
                <span class="modal-close" id="share-modal-close-button">×</span>
            </div>
            <div class="modal-body">
                <div class="room-info-display">
                    <p>Your Room PIN: <strong><span id="share-room-pin-display"></span></strong></p>
                    <p>Share this link:</p>
                    <p><strong><span id="share-room-link-display"></span></strong></p>
                </div>
                <div class="action-buttons">
                    <button id="copy-pin-button" class="btn">Copy PIN</button>
                    <button id="share-link-button" class="btn">Share Link</button>
                </div>
                <button id="share-modal-ok-button" class="btn btn-secondary" style="width: auto; margin-top: 20px;">OK</button>
            </div>
        </div>
    </div>

    <!-- Member List Modal -->
    <div id="member-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Room Members (<span id="member-list-count">0</span>)</h2>
                <span class="modal-close" id="member-list-close-button">×</span>
            </div>
            <div class="modal-body">
                <ul id="members-list">
                    <!-- Member names will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Emoji Modal -->
    <div id="emoji-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Choose Emoji</h2>
                <span class="modal-close" id="emoji-modal-close-button">×</span>
            </div>
            <div class="modal-body">
                <div id="emoji-grid">
                    <!-- Emojis will be populated here -->
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, remove, get, push, serverTimestamp, child, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Config and App Initialization ---
        const YOUTUBE_API_KEY = "AIzaSyDhgutAdO7mBbxWYR-TQ_YzBFOg5ND457I"; 
        const firebaseConfig = {
            apiKey: "AIzaSyA5QcieY9DNI1g5JFcrdOXrB_IyO9S3KGE",
            authDomain: "peacenotes-45a1a.firebaseapp.com",
            databaseURL: "https://peacenotes-45a1a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "peacenotes-45a1a",
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- State and Element Variables ---
        let currentRoomId, player, roomListeners = [], isSeeking = false, isPlayerReady = false, currentUserName;
        let lastKnownState = {}; 
        let roomMembers = {}; 
        let roomCreatorId = null; 
        let currentVolume = 100;
        let isMuted = false; 
        let isRepeatOn = false; 
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);
        const nameScreen = document.getElementById('name-screen'), nameInput = document.getElementById('name-input'), continueBtn = document.getElementById('continue-button'), welcomeMessage = document.getElementById('welcome-message'), homeScreen = document.getElementById('home-screen'), chatScreen = document.getElementById('chat-screen'), createRoomBtn = document.getElementById('create-room-button'), joinBtn = document.getElementById('join-button'), pinInput = document.getElementById('pin-input'), roomPinDisplay = document.getElementById('room-pin-display'), leaveRoomBtn = document.getElementById('leave-room-button'), messagesArea = document.getElementById('messages-area'), messageForm = document.getElementById('message-form'), messageInput = document.getElementById('message-input'), audioPlayerUI = document.getElementById('audio-player-ui'), albumArt = document.getElementById('album-art'), songTitle = document.getElementById('song-title'), songArtist = document.getElementById('song-artist'), playPauseBtn = document.getElementById('play-pause-button'), rewindBtn = document.getElementById('rewind-button'), forwardBtn = document.getElementById('forward-button'), progressBar = document.getElementById('progress-bar'), musicSearchBtn = document.getElementById('music-search-button'), searchModal = document.getElementById('search-modal'), modalCloseBtn = document.getElementById('modal-close-button'), modalSearchForm = document.getElementById('modal-search-form'), modalSearchInput = document.getElementById('modal-search-input'), searchResultsList = document.getElementById('search-results');
        
        const currentTimeDisplay = document.getElementById('current-time');
        const totalDurationDisplay = document.getElementById('total-duration');

        const deleteRoomModal = document.getElementById('delete-room-modal');
        const deleteModalCloseBtn = document.getElementById('delete-modal-close-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');

        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertCloseBtn = document.getElementById('custom-alert-close-button');

        const shareRoomModal = document.getElementById('share-room-modal');
        const shareRoomPinDisplay = document.getElementById('share-room-pin-display');
        const shareRoomLinkDisplay = document.getElementById('share-room-link-display');
        const copyPinButton = document.getElementById('copy-pin-button');
        const shareLinkButton = document.getElementById('share-link-button');
        const shareModalCloseBtn = document.getElementById('share-modal-close-button');
        const shareModalOkButton = document.getElementById('share-modal-ok-button');

        const musicPlayerPopup = document.getElementById('music-player-popup'); 
        const playerToggleViewButton = document.getElementById('player-toggle-view-button');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        
        const togglePinVisibilityButton = document.getElementById('toggle-pin-visibility-button');
        let isPinVisible = false; 

        const memberCountWrapper = document.getElementById('member-count-wrapper');
        const memberCountDisplay = document.getElementById('member-count-display');
        const memberListModal = document.getElementById('member-list-modal');
        const memberListCount = document.getElementById('member-list-count');
        const membersListUl = document.getElementById('members-list');
        const memberListCloseButton = document.getElementById('member-list-close-button');

        const albumArtContainer = document.getElementById('album-art-container');
        const albumArtImage = document.getElementById('album-art');
        const albumArtIcon = albumArtContainer.querySelector('.fa-headphones'); 

        const volumeSlider = document.getElementById('volume-slider');
        const muteButton = document.getElementById('mute-button');
        const repeatButton = document.getElementById('repeat-button');

        const emojiButton = document.getElementById('emoji-button');
        const emojiModal = document.getElementById('emoji-modal');
        const emojiModalCloseButton = document.getElementById('emoji-modal-close-button');
        const emojiGrid = document.getElementById('emoji-grid');
        const e2eNotice = document.getElementById('e2e-notice');


        let currentFileUrl = window.location.origin + window.location.pathname;

        // --- Helper for Alphanumeric Code Generation (GUARANTEED) ---
        function generateAlphanumericCode(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const nums = '0123456789';
            const allChars = chars + nums;
            let result = Array(length).fill('');
            let hasLetter = false;
            let hasNumber = false;

            for (let i = 0; i < length; i++) {
                result[i] = allChars.charAt(Math.floor(Math.random() * allChars.length));
                if (chars.includes(result[i])) hasLetter = true;
                if (nums.includes(result[i])) hasNumber = true;
            }

            if (!hasLetter) {
                const randomIndex = Math.floor(Math.random() * length);
                result[randomIndex] = chars.charAt(Math.floor(Math.random() * chars.length));
            }
            if (!hasNumber) {
                const randomIndex = Math.floor(Math.random() * length);
                result[randomIndex] = nums.charAt(Math.floor(Math.random() * nums.length));
            }
            
            return result.join('');
        }

        // --- Custom Alert Function ---
        function showCustomAlert(title, message) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';
            
            // Clear any old custom buttons or wrapper
            const oldButtonWrapper = customAlertModal.querySelector('.modal-button-wrapper');
            if(oldButtonWrapper) oldButtonWrapper.remove();

            // Always ensure the default OK button exists and is inside a wrapper for centering
            let buttonWrapper = document.createElement('div');
            buttonWrapper.classList.add('modal-button-wrapper');
            
            // If it's the standard alert, add the OK button.
            // If it's a custom confirm, the custom logic will add its own buttons.
            if (!customAlertModal.querySelector('#custom-alert-close-button')) { // Only add if not already there (prevents duplicates)
                customAlertCloseBtn.style.display = 'block'; // Ensure it's visible if it was hidden
                buttonWrapper.appendChild(customAlertCloseBtn);
            } else {
                 // The custom button logic will hide this or replace it.
                 // For now, if it exists, assume it will be handled by custom logic or is the single OK.
            }

            customAlertModal.querySelector('.modal-body').appendChild(buttonWrapper);
        }
        customAlertCloseBtn.addEventListener('click', () => customAlertModal.style.display = 'none');


        // --- Theme Toggle Function (from sample.html) ---
        function toggleTheme() {
            const bodyElement = document.body; 
            const currentTheme = bodyElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            bodyElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme); 
        }

        function updateThemeIcon(theme) {
            themeToggleButton.innerHTML = theme === 'dark' ? '<i data-lucide="sun" class="icon"></i>' : '<i data-lucide="moon" class="icon"></i>';
            lucide.createIcons(); 
        }

        themeToggleButton.addEventListener('click', toggleTheme);

        // Apply saved theme on load (from sample.html)
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const initialTheme = savedTheme || 'light'; 
            document.body.setAttribute('data-theme', initialTheme);
            updateThemeIcon(initialTheme); 
        });


        // --- Core App Logic (Name, Rooms, Chat) ---
        continueBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                currentUserName = name;
                welcomeMessage.textContent = `Welcome, ${currentUserName}!`;
                
                const urlParams = new URLSearchParams(window.location.search);
                const roomIdFromUrl = urlParams.get('room');
                if (roomIdFromUrl) {
                    joinRoom(roomIdFromUrl, false); 
                } else {
                    nameScreen.classList.remove('active');
                    homeScreen.classList.add('active'); 
                }
            } else {
                showCustomAlert('Error', 'Please enter your name.');
            }
        });
        
        createRoomBtn.addEventListener('click', () => {
            const newRoomId = generateAlphanumericCode(6);
            joinRoom(newRoomId, true); 
        });
        
        joinBtn.addEventListener('click', () => {
            const roomId = pinInput.value.trim();
            if (roomId) {
                joinRoom(roomId, false); 
            } else {
                showCustomAlert('Error', 'Please enter a Room PIN.');
            }
        });
        
        leaveRoomBtn.addEventListener('click', async () => {
            if (!currentRoomId) return;
            const membersSnapshot = await get(child(ref(db, `rooms/${currentRoomId}`), 'members'));
            const memberCount = membersSnapshot.exists() ? membersSnapshot.size : 0;

            if (memberCount === 1) { 
                deleteRoomModal.style.display = 'flex'; 
            } else { 
                await executeLeaveAndDeletion(false); 
            }
        });

        async function executeLeaveAndDeletion(shouldDeleteRoomConfirmedByUser) {
            if (!currentRoomId) return;

            const roomRef = ref(db, `rooms/${currentRoomId}`);
            const memberRef = child(roomRef, `members/${userId}`);
            
            await remove(memberRef); 

            let shouldDeleteRoom = shouldDeleteRoomConfirmedByUser;

            if (!shouldDeleteRoom) { 
                const currentMembersSnapshot = await get(child(roomRef, 'members'));
                if (!currentMembersSnapshot.exists() || currentMembersSnapshot.size === 0) {
                    console.log(`Room became empty after user left. Auto-deleting room: ${currentRoomId}`);
                    shouldDeleteRoom = true; 
                }
            }

            if (shouldDeleteRoom) {
                console.log(`Permanently deleting room: ${currentRoomId}`);
                await remove(roomRef); 
            } else {
                console.log(`User left, room ${currentRoomId} remains (other members might still be there).`);
            }
            
            roomListeners.forEach(off => off());
            roomListeners = [];
            currentRoomId = null;
            if (player) player.stopVideo();
            chatScreen.classList.remove('active');
            homeScreen.classList.add('active');
            messagesArea.innerHTML = '';
            musicPlayerPopup.classList.remove('visible'); 
            setTimeout(() => musicPlayerPopup.style.display = 'none', 300); 
            currentTimeDisplay.textContent = "00:00";
            totalDurationDisplay.textContent = "00:00";
            progressBar.value = 0;
            songTitle.textContent = "No music selected";
            songArtist.textContent = "Use the search button to find music";
            playerToggleViewButton.innerHTML = 'Vibana <i class="fas fa-plus"></i>'; 

            deleteRoomModal.style.display = 'none'; 
        }

        deleteModalCloseBtn.addEventListener('click', () => { deleteRoomModal.style.display = 'none'; });
        confirmDeleteButton.addEventListener('click', () => { executeLeaveAndDeletion(true); });
        cancelDeleteButton.addEventListener('click', () => { deleteRoomModal.style.display = 'none'; });

        async function joinRoom(roomId, isNewRoom = false) {
            let roomExists = (await get(ref(db, `rooms/${roomId}`))).exists();

            if (!isNewRoom && !roomExists) {
                showCustomAlert('Room Not Found', 'Room does not exist or has been deleted. Please check the PIN or create a new room.');
                return; 
            }
            if (isNewRoom && roomExists) {
                 showCustomAlert('Room Exists', 'A room with this PIN already exists. Please try creating a new one or join the existing one.');
                 return; 
            }

            currentRoomId = roomId;
            const membersRef = ref(db, `rooms/${currentRoomId}/members/${userId}`);
            set(membersRef, { name: currentUserName });
            if (isNewRoom) {
                set(child(ref(db, `rooms/${currentRoomId}`), 'creatorId'), userId);
            }
            onDisconnect(membersRef).remove();
            homeScreen.classList.remove('active');
            chatScreen.classList.add('active');
            
            roomPinDisplay.textContent = currentRoomId; 
            roomPinDisplay.classList.add('hidden-pin'); 
            togglePinVisibilityButton.innerHTML = '<i class="fas fa-eye"></i>'; 

            messagesArea.innerHTML = '';
            e2eNotice.classList.remove('hidden'); 

            attachRoomListeners();

            if (isNewRoom) {
                showRoomCreatedModal(roomId); 
            }
        }
        messageForm.addEventListener('submit', e => { e.preventDefault(); const text = messageInput.value.trim(); if (text && currentRoomId) {
            set(push(ref(db, `rooms/${currentRoomId}/messages`)), { text, senderId: userId, senderName: currentUserName, timestamp: serverTimestamp() }); 
            messageInput.value = '';
            e2eNotice.classList.add('hidden');
        }});
        function displayMessage(msg, type) { const el = document.createElement('div'); el.classList.add('message', type); el.innerHTML = `<span class="sender-name">${type === 'sent' ? 'You' : msg.senderName}</span><div>${msg.text}</div>`; messagesArea.appendChild(el); messagesArea.scrollTop = messagesArea.scrollHeight; }
        function displaySystemMessage(text) { const el = document.createElement('div'); el.classList.add('message', 'system'); el.textContent = text; messagesArea.appendChild(el); messagesArea.scrollTop = messagesArea.scrollHeight; }

        // --- Room PIN Visibility Toggle ---
        togglePinVisibilityButton.addEventListener('click', () => {
            isPinVisible = !isPinVisible;
            if (isPinVisible) {
                roomPinDisplay.classList.remove('hidden-pin');
                togglePinVisibilityButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                roomPinDisplay.classList.add('hidden-pin');
                togglePinVisibilityButton.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });

        // --- Member List Display Logic ---
        memberCountWrapper.addEventListener('click', () => {
            membersListUl.innerHTML = ''; 
            for (const memberId in roomMembers) {
                const memberName = roomMembers[memberId].name;
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-user-circle"></i> ${memberName} ${memberId === userId ? '(You)' : ''}`;
                
                if (userId === roomCreatorId && memberId !== userId) {
                    const kickBtn = document.createElement('button');
                    kickBtn.classList.add('kick-btn');
                    kickBtn.innerHTML = '<i class="fas fa-user-minus"></i>';
                    kickBtn.title = `Kick ${memberName}`;
                    kickBtn.addEventListener('click', async () => {
                        memberListModal.style.display = 'none'; 
                        
                        // Use showCustomAlert for confirmation
                        showCustomAlert('Confirm Kick', `Are you sure you want to kick ${memberName} from the room?`);
                        
                        // Get the newly created button wrapper from showCustomAlert
                        const alertButtonWrapper = customAlertModal.querySelector('.modal-button-wrapper');
                        
                        // Remove the default 'OK' button from the alert
                        const defaultOkBtn = customAlertModal.querySelector('#custom-alert-close-button');
                        if (defaultOkBtn) defaultOkBtn.remove(); // Ensure it's removed if present

                        const confirmYesBtn = document.createElement('button');
                        confirmYesBtn.classList.add('btn');
                        confirmYesBtn.style.cssText = 'width:auto; background:#e74c3c;'; 
                        confirmYesBtn.textContent = 'Yes, Kick';
                        confirmYesBtn.onclick = async () => {
                            await remove(child(ref(db, `rooms/${currentRoomId}/members`), memberId));
                            showCustomAlert('Member Kicked', `${memberName} has been removed.`);
                            // showCustomAlert now handles cleanup of its own buttons automatically
                        };
                        
                        const confirmNoBtn = document.createElement('button');
                        confirmNoBtn.classList.add('btn', 'btn-secondary');
                        confirmNoBtn.style.cssText = 'width:auto;'; 
                        confirmNoBtn.textContent = 'No, Cancel';
                        confirmNoBtn.onclick = () => {
                            customAlertModal.style.display = 'none';
                            // showCustomAlert's button setup cleans up its own default OK button
                        };
                        
                        if(alertButtonWrapper){ // Add custom buttons to the alert's button wrapper
                            alertButtonWrapper.appendChild(confirmYesBtn);
                            alertButtonWrapper.appendChild(confirmNoBtn);
                        } else { // Fallback if wrapper wasn't found (shouldn't happen with current showCustomAlert)
                            customAlertModal.querySelector('.modal-body').appendChild(confirmYesBtn);
                            customAlertModal.querySelector('.modal-body').appendChild(confirmNoBtn);
                        }
                    });
                    li.appendChild(kickBtn);
                }
                membersListUl.appendChild(li);
            }
            memberListCount.textContent = Object.keys(roomMembers).length;
            memberListModal.style.display = 'flex';
        });
        memberListCloseButton.addEventListener('click', () => memberListModal.style.display = 'none');


        // --- ROCK-SOLID Audio Sync Logic ---
        function attachRoomListeners() {
            roomListeners.forEach(off => off()); roomListeners = [];
            const audioStateRef = ref(db, `rooms/${currentRoomId}/audioState`);
            const messagesRef = ref(db, `rooms/${currentRoomId}/messages`);
            const membersRef = ref(db, `rooms/${currentRoomId}/members`);
            const roomCreatorRef = ref(db, `rooms/${currentRoomId}/creatorId`);
            
            const audioOff = onValue(audioStateRef, (snapshot) => {
                if (!snapshot.exists()) { 
                    musicPlayerPopup.classList.remove('visible'); 
                    setTimeout(() => musicPlayerPopup.style.display = 'none', 300); 
                    updatePlayerUIForNoMusic(); 
                    return; 
                }
                
                const state = snapshot.val();
                lastKnownState = state; 
                
                musicPlayerPopup.style.display = 'block';
                setTimeout(() => musicPlayerPopup.classList.add('visible'), 10); 

                if (isPlayerReady) { 
                    if (state.lastUpdatedBy === userId) {
                        updatePlayerUI(state); 
                    } else {
                        syncLocalPlayerToState(state);
                        updatePlayerUI(state); 
                    }
                } else {
                    updatePlayerUI(state); 
                }
            });
            
            const messagesOverallOff = onValue(messagesRef, (snapshot) => {
                if (snapshot.exists() && Object.keys(snapshot.val()).length > 0) {
                    e2eNotice.classList.add('hidden');
                } else {
                    e2eNotice.classList.remove('hidden');
                }
                messagesArea.innerHTML = ''; 
                if (snapshot.exists()) {
                    Object.values(snapshot.val()).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)).forEach(msg => {
                        displayMessage(msg, msg.senderId === userId ? 'sent' : 'received');
                    });
                }
            });
            
            const membersOverallOff = onValue(membersRef, (snapshot) => {
                roomMembers = {}; 
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        roomMembers[childSnapshot.key] = childSnapshot.val();
                    });
                }
                memberCountDisplay.textContent = Object.keys(roomMembers).length;
                if (memberListModal.style.display === 'flex') {
                    memberCountWrapper.click(); 
                }
                if (!snapshot.child(userId).exists() && currentRoomId !== null && chatScreen.classList.contains('active')) { 
                     console.log(`User ${userId} was removed from room ${currentRoomId}. Redirecting.`);
                     showCustomAlert('Kicked Out', 'You have been kicked out of the room by the creator.');
                     setTimeout(() => {
                         executeLeaveAndDeletion(false); 
                     }, 2000); 
                }
            });

            const creatorIdOff = onValue(roomCreatorRef, (snapshot) => {
                if (snapshot.exists()) {
                    roomCreatorId = snapshot.val();
                } else {
                    roomCreatorId = null;
                }
            });


            roomListeners.push(audioOff, messagesOverallOff, membersOverallOff, creatorIdOff);
        }

        window.onYouTubeIframeAPIReady = () => player = new YT.Player('youtube-player-hidden', { 
            events: { 
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange 
            }
        });

        function onPlayerReady() {
            isPlayerReady = true;
            player.setVolume(currentVolume); 
            volumeSlider.value = currentVolume; 
            if (Object.keys(lastKnownState).length > 0) { 
                syncLocalPlayerToState(lastKnownState);
                updatePlayerUI(lastKnownState); 
            } else {
                updatePlayerUIForNoMusic(); 
            }
        }

        function updatePlayerUI(state) {
            albumArtImage.src = state.thumbnail;
            albumArtImage.style.display = 'block';
            albumArtIcon.style.display = 'none';

            songTitle.textContent = state.title;
            songArtist.textContent = state.artist;
            
            playPauseBtn.innerHTML = state.isPlaying ? '<i class="fas fa-pause-circle"></i>' : '<i class="fas fa-play-circle"></i>';
        }

        function updatePlayerUIForNoMusic() {
            albumArtImage.style.display = 'none';
            albumArtIcon.style.display = 'block'; 

            songTitle.textContent = "No music selected";
            songArtist.textContent = "Use the search button to find music";
            
            currentTimeDisplay.textContent = "00:00";
            totalDurationDisplay.textContent = "00:00";
            progressBar.value = 0;
            progressBar.max = 0;
            playPauseBtn.innerHTML = '<i class="fas fa-play-circle"></i>'; 
        }

        function syncLocalPlayerToState(state) {
            if (!isPlayerReady || !player) return;

            if (player.getVideoData()?.video_id !== state.videoId) {
                player.loadVideoById({videoId: state.videoId, startSeconds: state.timestamp});
            } else {
                if (Math.abs(player.getCurrentTime() - state.timestamp) > 2.5) {
                    player.seekTo(state.timestamp, true);
                }
            }

            if (state.isPlaying && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                player.playVideo();
            } else if (!state.isPlaying && player.getPlayerState() === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            }
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isRepeatOn) {
                    player.seekTo(0);
                    player.playVideo();
                    updateFirebaseAudioState({timestamp: 0, isPlaying: true});
                } else {
                    updateFirebaseAudioState({isPlaying: false, timestamp: 0});
                }
            }
            if (!isSeeking && (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED)) {
                updateFirebaseAudioState({}); 
            }
        }


        function updateFirebaseAudioState(newStateProperties) {
            if (!currentRoomId || !player) return; 

            const videoId = player.getVideoData()?.video_id || (lastKnownState.videoId || '');
            const title = player.getVideoData()?.title || (lastKnownState.title || 'No music selected');
            const artist = player.getVideoData()?.author || (lastKnownState.artist || 'Unknown Artist');
            const thumbnail = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : (lastKnownState.thumbnail || 'https://via.placeholder.com/150');


            const currentState = {
                videoId: videoId,
                title: title,
                artist: artist,
                thumbnail: thumbnail,
                isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING,
                timestamp: player.getCurrentTime(),
                lastUpdatedBy: userId 
            };
            const finalState = { ...currentState, ...newStateProperties };
            set(ref(db, `rooms/${currentRoomId}/audioState`), finalState);
        }

        playPauseBtn.addEventListener('click', () => {
            if (!currentRoomId || !lastKnownState.videoId) return;

            const newIsPlaying = !lastKnownState.isPlaying;
            if (newIsPlaying) player.playVideo(); else player.pauseVideo(); 
            updateFirebaseAudioState({ isPlaying: newIsPlaying }); 
        });

        rewindBtn.addEventListener('click', () => {
            if (!currentRoomId || !lastKnownState.videoId) return;
            const newTime = Math.max(0, player.getCurrentTime() - 10);
            player.seekTo(newTime, true); 
            updateFirebaseAudioState({ timestamp: newTime }); 
        });
        
        forwardBtn.addEventListener('click', () => {
            if (!currentRoomId || !lastKnownState.videoId) return;
            const newTime = Math.min(player.getDuration(), player.getCurrentTime() + 10);
            player.seekTo(newTime, true); 
            updateFirebaseAudioState({ timestamp: newTime }); 
        });
        
        progressBar.addEventListener('input', () => isSeeking = true);
        progressBar.addEventListener('change', () => {
            if (!currentRoomId || !lastKnownState.videoId) return;
            isSeeking = false;
            const newTime = parseFloat(progressBar.value);
            player.seekTo(newTime, true); 
            updateFirebaseAudioState({ timestamp: newTime }); 
        });
        
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        setInterval(() => {
            if (player && player.getPlayerState && !isSeeking) {
                const duration = player.getDuration() || 0;
                const currentTime = player.getCurrentTime() || 0;

                progressBar.max = duration;
                progressBar.value = currentTime;

                currentTimeDisplay.textContent = formatTime(currentTime);
                totalDurationDisplay.textContent = formatTime(duration);
            } else {
                currentTimeDisplay.textContent = "00:00";
                totalDurationDisplay.textContent = "00:00";
            }
        }, 500);

        volumeSlider.addEventListener('input', () => {
            currentVolume = parseInt(volumeSlider.value);
            if (player) {
                player.setVolume(currentVolume);
                isMuted = false; 
                muteButton.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        });

        muteButton.addEventListener('click', () => {
            if (!player) return;
            if (isMuted) {
                player.unMute();
                player.setVolume(currentVolume); 
                muteButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                volumeSlider.value = currentVolume;
                isMuted = false;
            } else {
                player.mute();
                muteButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
                volumeSlider.value = 0;
                isMuted = true;
            }
        });

        repeatButton.addEventListener('click', () => {
            isRepeatOn = !isRepeatOn;
            repeatButton.classList.toggle('active', isRepeatOn); 
            showCustomAlert('Repeat Mode', isRepeatOn ? 'Repeat is ON' : 'Repeat is OFF');
        });


        // --- Search Modal & Song Selection ---
        musicSearchBtn.addEventListener('click', () => { searchModal.style.display = 'flex'; modalSearchInput.focus(); });
        modalCloseBtn.addEventListener('click', () => searchModal.style.display = 'none');
        modalSearchForm.addEventListener('submit', async (e) => { e.preventDefault(); const query = modalSearchInput.value.trim(); if(query) await searchYouTube(query); });
        
        function selectSong(songData) {
            searchModal.style.display = 'none';

            if (isPlayerReady) {
                player.loadVideoById({videoId: songData.videoId, startSeconds: 0});
                player.playVideo(); 
            }

            const newAudioState = {
                videoId: songData.videoId, title: songData.title, artist: songData.artist,
                thumbnail: songData.thumbnail, isPlaying: true, timestamp: 0, lastUpdatedBy: userId
            };
            updateFirebaseAudioState(newAudioState); 
            
            musicPlayerPopup.style.display = 'block';
            setTimeout(() => musicPlayerPopup.classList.add('visible'), 10); 
            playerToggleViewButton.innerHTML = 'Vibana <i class="fas fa-minus"></i>';
        }

        async function searchYouTube(query) {
             const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}&type=video&maxResults=5`;
             searchResultsList.innerHTML = '<li>Searching...</li>';
             try {
                const response = await fetch(url);
                const data = await response.json();
                searchResultsList.innerHTML = '';
                if (data.items?.length > 0) {
                    data.items.forEach(video => {
                        const li = document.createElement('li');
                        li.className = 'search-result-item';
                        li.dataset.videoId = video.id.videoId;
                        li.dataset.title = video.snippet.title;
                        li.dataset.artist = video.snippet.channelTitle;
                        li.dataset.thumbnail = video.snippet.thumbnails.high.url;
                        li.innerHTML = `<img src="${video.snippet.thumbnails.default.url}" alt="t"><div class="search-result-info"><h4>${video.snippet.title}</h4><p>${video.snippet.channelTitle}</p></div>`;
                        li.addEventListener('click', () => selectSong(li.dataset));
                        searchResultsList.appendChild(li);
                    });
                } else { searchResultsList.innerHTML = '<li>No results found.</li>'; }
             } catch(e) { console.error(e); showCustomAlert('Error', 'Could not search. Check API Key or network.'); searchResultsList.innerHTML = '<li>Error: Could not fetch results.</li>'; }
        }
        
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        // --- Share Room Modal Logic ---
        function showRoomCreatedModal(roomId) {
            const shareLink = `${currentFileUrl}?room=${roomId}`;
            shareRoomPinDisplay.textContent = roomId;
            shareRoomLinkDisplay.textContent = shareLink;
            shareRoomModal.style.display = 'flex';
        }

        shareModalCloseBtn.addEventListener('click', () => shareRoomModal.style.display = 'none');
        shareModalOkButton.addEventListener('click', () => shareRoomModal.style.display = 'none');

        copyPinButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(shareRoomPinDisplay.textContent);
                showCustomAlert('Copied!', 'Room PIN has been copied to your clipboard.');
            } catch (err) {
                showCustomAlert('Error', 'Failed to copy PIN. Please copy it manually.');
                console.error('Failed to copy PIN: ', err);
            }
        });

        shareLinkButton.addEventListener('click', async () => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Join my PeaceNotes Room!',
                        text: `Hey, join my PeaceNotes room! PIN: ${shareRoomPinDisplay.textContent}`,
                        url: shareRoomLinkDisplay.textContent,
                    });
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Share operation aborted.');
                    } else {
                        showCustomAlert('Error', 'Failed to share link. Please copy it manually.');
                        console.error('Error sharing:', error);
                    }
                }
            } else {
                try {
                    await navigator.clipboard.writeText(shareRoomLinkDisplay.textContent);
                    showCustomAlert('Copied!', 'Room link has been copied to your clipboard (Web Share API not supported).');
                } catch (err) {
                    showCustomAlert('Error', 'Failed to copy link. Please copy it manually.');
                    console.error('Failed to copy link: ', err);
                }
            }
        });

        // --- Minimize/Maximize Player Logic (Controlled by header button) ---
        playerToggleViewButton.addEventListener('click', togglePlayerPopup);

        function togglePlayerPopup() {
            if (musicPlayerPopup.classList.contains('visible')) {
                musicPlayerPopup.classList.remove('visible');
                setTimeout(() => musicPlayerPopup.style.display = 'none', 300); 
                playerToggleViewButton.innerHTML = 'Vibana <i class="fas fa-plus"></i>'; 
            } else {
                musicPlayerPopup.style.display = 'block';
                setTimeout(() => musicPlayerPopup.classList.add('visible'), 10); 
                playerToggleViewButton.innerHTML = 'Vibana <i class="fas fa-minus"></i>'; 
            }
        }
        // Emoji Picker Logic
        const emojis = [
            '😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙',
            '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥',
            '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐',
            '😕', '😟', '🙁', '😮', '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😩', '🤯', '😬', '😓', '😔', '😖', '😫', '😩', '😤',
            '😠', '😡', '🤬', '😈', '👿', '💀', '👻', '👽', '🤖', '💩', '😺', '😸', '😹', '😻', '😼', '😽', '😾', '😿', '🙀', '👋',
            '🤚', '🖐️', '✋', '🖖', '👌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '👏',
            '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦵', '🦶', '👂', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅',
            '👄', '💋', '🩸', '🦠', '🧑‍🎄', '🦸', '🦹', '🧙', '🧚', '🧛', '🧜', '🧝', '🧞', '🧟', '🧑‍🦱', '🧑‍🦰', '🧑‍🦳', '🧑‍🦲', '👶', '🧒',
            '👦', '👧', '🧑', '👱', '👨', '🧔', '👩', '🧓', '👴', '👵', '🙍', '🙎', '🙅', '🙆', '💁', '🙋', '🧏', '🙇', '🧑‍🍼', '👮',
            '🕵️', '👷', '👨‍🌾', '👩‍🍳', '👨‍🎓', '👩‍🎤', '👨‍🏫', '👩‍🏭', '👨‍💻', '👩‍💼', '👨‍🔧', '👩‍🔬', '👨‍🎨', '👩‍🚒', '👨‍✈️', '👩‍🚀', '👨‍⚖️', '👰', '🤵',
            '👑', '👸', '🤴', '🥷', '🫂', '🗣️', '👤', '👥', '🫂', '👣', '🐵', '🐒', '🦍', '🦧', '🐶', '🐕', '🐩', '🐺', '🦊', '🦝',
            '🐱', '🐈', '🦁', '🐯', '🐅', '🐆', '🐴', '🐎', '🦄', '🦓', '🦌', '🐮', '🐂', '🐃', '🐄', '🐷', '🐖', '🐗', '🐽', '🐏',
            '🐑', '🐐', '🐪', '🐫', '🦙', '🦒', '🐘', '🦣', '🦏', '🦛', '🐭', '🐁', '🐀', '🐹', '🐰', '🐇', '🐿️', '🦫', '🦔', '🦇',
            '🐻', '🐨', '🐼', '🦥', '🦦', '🦨', '🦘', '🦡', '🐾', '🦃', '🐔', '🐓', '🐣', '🐤', '🐥', '🐦', '🐧', '🕊️', '🦅', '🦆',
            '🦢', '🦉', '🦩', '🦚', '🦜', '🐸', '🐊', '🐢', '🦎', '🐍', '🐲', '🐉', '🦕', '🦖', '🐳', '🐋', '🐬', '🦭', '🐟', '🐠',
            '🐡', '🦈', '🐙', '🐚', '🦀', '🦐', '🦑', '🐌', '🦋', '🐛', '🐜', '🐝', '🐞', '🦗', '🪳', '🕷️', '🕸️', '🦂', ' Mosquito', '🪰',
            '🪱', '💐', '🌸', '💮', '🏵️', '🌹', '🥀', '🌺', '🌻', '🌼', '🌷', '🌱', '🌲', '🌳', '🌴', '🌵', '🌾', '🌿', '☘️', '🍀',
            '🍁', '🍂', '🍃', '🍄', '🌰', '🌎', '🌍', '🌏', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓', '🌔', '🌙', '🌚', '🌛', '🌜',
            '⭐', '🌟', '💫', '✨', '⚡', '☄️', '💥', '🔥', '💧', '🌊', '🌈', '🌪️', '☁️', '☀️', '🌞', '☔', '☂️', '☃️', '⛄', '❄️',
            '🌬️', '💨', 'fog', '🌀', '🌡️', '🎄', '🎁', '🎈', '🎉', '🎊', '🎀', '🪄', '💖', '💗', '❤️', '🧡', '💛', '💚', '💙', '💜',
            '🤎', '🖤', '🤍', '💔', '❣️', '💕', '💞', '💓', '💔', '❤️‍🔥', '❤️‍🩹', '💯', '💢', '💥', '💫', '💦', '💨', '🕳️', '💣', '💬',
            '👁️‍🗨️', '🗯️', '💭', '💤', '💮', '♨️', '💈', '🛑', '🔔', '🔕', '📣', '📢', 'スピーカー', '🔈', '🔉', '🔊', '🔋', '🔌', '💻', '🖥️',
            '⌨️', '🖱️', '🖨️', '💾', '💿', '📀', '🧮', '📱', '📞', '☎️', 'PAGER', 'FAX', '📻', '🎙️', '🎚️', '🎛️', '🧭', '⏱️', '⏲️', '⏰',
            '🕰️', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🗑️', '🛢️', '🛒', '🛍️', '💰', '🪙', '💸', '💵', '💶', '💷', '💴', '💳',
            '✉️', '📧', '📨', '📩', '📤', '📥', '📦', '📫', '📪', '📬', '📮', '🗳️', '✏️', '✒️', '🖊️', '🖍️', '🖌️', '📝', '💼', '📁',
            '📂', '🗂️', '📅', '📆', '🗒️', '🗓️', '📖', '📚', '🔖', '🏷️', '📜', '📊', '📈', '📉', '📄', '📃', '📋', '🔗', '📎', '📌',
            '📎', '📍', '📏', '📐', '✂️', '🗃️', '🗄️', '🗑️', '🔒', '🔓', '🔏', '🔐', '🔑', '🗝️', '🗡️', '🛡️', '⚙️', '🪛', '🔩', '🔨',
            '⛏️', '🪓', '🔪', '🔫', '🪖', '🪜', '🧱', '⛓️', '🪝', '🧲', '🚪', '🪞', '🪟', '🛏️', '🛋️', '🪑', '🚽', '🚿', '🛁', '🪠',
            '🧴', '🧼', '🧽', '🧹', '🧺', '🧻', '🚽', '🛎️', '🔑', '🗝️', '🚪', '🛗', '🪜', '🪞', '🪟', '🛏️', '🛋️',
        ];

        emojiButton.addEventListener('click', () => {
            emojiGrid.innerHTML = ''; 
            emojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.classList.add('emoji-item');
                emojiSpan.textContent = emoji;
                emojiSpan.addEventListener('click', () => {
                    messageInput.value += emoji; 
                    emojiModal.style.display = 'none'; 
                    messageInput.focus(); 
                });
                emojiGrid.appendChild(emojiSpan);
            });
            emojiModal.style.display = 'flex';
        });

        emojiModalCloseButton.addEventListener('click', () => emojiModal.style.display = 'none');

    </script>
</body>
</html>
